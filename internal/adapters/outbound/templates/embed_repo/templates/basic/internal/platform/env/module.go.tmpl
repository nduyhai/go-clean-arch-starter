package env

import (
	"fmt"
	"strings"

	"github.com/spf13/viper"
	"go.uber.org/fx"
)

type Config struct {
	Logger struct {
		Level string `mapstructure:"level"`
	} `mapstructure:"logger"`
}

func Module() fx.Option {
	return fx.Provide(
		func() (*Config, error) {
			v := viper.New()
			v.SetConfigName("config")
			v.SetConfigType("yaml")
			v.AddConfigPath("config")
			v.AutomaticEnv()
			v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))

			if err := v.ReadInConfig(); err != nil {
				return nil, fmt.Errorf("read config: %w", err)
			}

			var cfg Config
			if err := v.Unmarshal(&cfg); err != nil {
				return nil, fmt.Errorf("unmarshal config: %w", err)
			}

			return &cfg, nil
		},
	)
}
